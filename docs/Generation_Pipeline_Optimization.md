# Axioma Qbank 생성 대기시간 개선 파이프라인 기획서

## 1. 문제 정의
- 현재 생성 흐름은 `문제 생성 시작` 클릭 시점에
  - 강의자료 텍스트 추출
  - (선택) 스타일 파일 텍스트 추출
  - 청크 분할
  - LLM 호출
  를 순차 수행한다.
- 사용자는 `업로드 후 1차 대기` + `생성 중 2차 대기`를 체감한다.

## 2. 목표
- 업로드 직후 전처리를 미리 수행해 생성 버튼 이후 대기시간을 단축한다.
- 같은 파일/같은 설정으로 재시도할 때 텍스트 재추출을 생략한다.
- 기능 동작은 기존과 동일하게 유지하고, 실패 시 기존 동작으로 폴백한다.

## 3. 파이프라인 구조 (V1)

### Stage A: 업로드/식별
- 입력 파일 바이트 해시(`sha256`)와 파일 확장자를 계산한다.
- 캐시 키:
  - `raw:<file_hash>:<ext>`
  - `style:<file_hash>:<ext>`
  - `chunk_plan:<raw_hash>:<chunk_size>:<overlap>`

### Stage B: 사전 전처리 (Prewarm)
- 사용자가 파일을 올리고 저작권 체크를 완료하면 즉시:
  - 강의자료 텍스트 추출(한 번만)
  - 스타일 파일 텍스트 추출(있으면, 한 번만)
  - 문서 길이/예상 청크 수 계산
- 결과를 세션 캐시에 저장한다.

### Stage C: 생성 실행
- `문제 생성 시작` 클릭 시:
  - 캐시에 `raw/style` 텍스트가 있으면 즉시 재사용
  - 없으면 즉시 추출(폴백)
  - 이후 LLM 생성만 수행

### Stage D: 재시도/재생성
- 같은 파일 + 같은 설정이면 재추출 없이 생성 단계만 재실행한다.
- 파일이 바뀌면 캐시 키가 바뀌어 자동으로 새 전처리를 수행한다.

## 4. UI/UX 변경 (V1)
- 생성 탭에 `사전 준비 상태`를 표시:
  - 준비 중 / 준비 완료 / 실패
  - 추출 글자 수, 예상 청크 수
- `문제 생성 시작`은 준비 상태를 우선 사용한다.
- `사전 준비 다시 실행` 버튼 제공(강제 refresh).

## 5. 실패 대응
- 전처리 실패 시 에러 메시지를 표시하고 기존 즉시 추출 경로로 폴백한다.
- 스타일 파일 파싱 실패는 경고만 띄우고 생성 자체는 계속 진행한다.

## 6. 성능 기대치 (상대 기준)
- 첫 실행: 기존과 유사하지만, 전처리가 설정 입력 시간과 겹쳐 체감 대기 감소.
- 재실행/재시도: 텍스트 추출 단계 생략으로 대기시간 유의미하게 단축.
- 파일 전환: 새 캐시 키로 새 전처리 수행(정확성 유지).

## 7. 계측/검증 지표
- `t_extract_raw_ms`, `t_extract_style_ms`, `t_generate_ms`, `t_total_ms`
- 캐시 히트율: `prewarm_hit_raw`, `prewarm_hit_style`
- 사용자 체감: 생성 버튼 이후 완료까지 시간

## 8. 수용 기준
- 같은 파일로 재생성 시 텍스트 추출 함수가 재호출되지 않는다(캐시 히트).
- 파일 변경 시 전처리가 다시 수행된다(캐시 미스).
- 전처리 실패가 있어도 기존 생성 경로로 문항 생성이 가능하다.

## 9. 구현 범위 (이번 적용)
- 세션 기반 전처리 캐시/키 생성 로직 추가
- 생성 탭 사전 준비 상태 표시 및 재실행 버튼 추가
- 생성 실행 시 캐시 우선 사용 + 폴백
- 캐시 동작 검증 단위 테스트 추가

## 10. 다음 단계 (V2)
- 백그라운드 작업 큐(Celery/RQ)로 비동기 생성
- 작업 ID 기반 진행률/취소/결과 조회
- 전처리 캐시를 세션이 아닌 사용자 영속 저장소로 확장
